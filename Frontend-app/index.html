<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verified ID Sample - Professional Helpdesk</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <style>
        .navbar-brand {
            font-weight: bold;
        }

        .hero-section {
            min-height: 70vh;
            display: flex;
            align-items: center;
        }

        .card-hover {
            transition: transform 0.2s;
        }

        .card-hover:hover {
            transform: translateY(-5px);
        }

        .progress-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: conic-gradient(#198754 0deg, #e9ecef 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }

        .progress-circle-inner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
        }

        .qr-container {
            text-align: center;
            margin: 20px 0;
        }

        .status-section {
            display: none;
            margin-top: 20px;
        }

        .photo-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
        }

        .pin-code {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0d6efd;
            margin-top: 15px;
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#" onclick="showHomePage()">
                <i class="bi bi-shield-check"></i> Verified ID Sample
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="renderIssuanceUI()">
                            <i class="bi bi-plus-circle"></i> Obtain Credential
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="renderPresentationUI()">
                            <i class="bi bi-card-checklist"></i> Present Credentials
                        </a>
                    </li>
                </ul>

                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/yoelhor/vid-logic-app-2" target="_blank">
                            <i class="bi bi-github"></i> GitHub
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/yoelhor/vid-logic-app-2/privacy" target="_blank">
                            <i class="bi bi-shield-lock"></i> Privacy
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container-fluid">
        <!-- Home Page -->
        <div id="homePage" class="hero-section">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <div class="text-center mb-5">
                            <h1 class="display-5 mb-3">Your Gateway to Verified ID Credentials</h1>
                            <p class="lead text-muted">Secure credential issuance and verification sample application
                            </p>
                        </div>

                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="card h-100 shadow-sm card-hover" onclick="renderIssuanceUI()">
                                    <div class="card-body text-center p-5">
                                        <div class="mb-3">
                                            <i class="bi bi-plus-circle text-primary" style="font-size: 3rem;"></i>
                                        </div>
                                        <h3 class="card-title">Obtain Credential</h3>
                                        <p class="card-text text-muted">Request and receive your Verified ID digital
                                            credential</p>
                                        <button class="btn btn-primary btn-lg">Get Started</button>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card h-100 shadow-sm card-hover" onclick="renderPresentationUI()">
                                    <div class="card-body text-center p-5">
                                        <div class="mb-3">
                                            <i class="bi bi-card-checklist text-primary" style="font-size: 3rem;"></i>
                                        </div>
                                        <h3 class="card-title">Present Credential</h3>
                                        <p class="card-text text-muted">Share your verified credentials securely with
                                            us</p>
                                        <button class="btn btn-primary btn-lg">Present Now</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Issuance UI -->
        <div id="issuanceUI" class="hero-section" style="display: none;">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card shadow">
                            <div class="card-header bg-primary text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h2 class="mb-0">
                                        <i class="bi bi-plus-circle"></i> Obtain New Credential
                                    </h2>
                                    <button type="button" class="btn btn-primary" onclick="showHomePage()">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">

                                <!-- Issuance Form -->
                                <form id="issuanceForm">
                                    <div class="mb-3">
                                        <label for="displayName" class="form-label">Display Name</label>
                                        <input type="text" class="form-control" id="displayName" required>
                                    </div>

                                    <div class="mb-3">
                                        <label for="photoUpload" class="form-label">Upload Photo</label>
                                        <input type="file" class="form-control" id="photoUpload" accept="image/*">
                                        <div id="photoPreview"></div>
                                    </div>

                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="bi bi-send"></i> Submit Request
                                    </button>
                                </form>

                                <!-- Error message for issuance -->
                                <div id="issuanceErrorContainer" class="alert alert-danger" style="display: none;"
                                    role="alert">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <span id="issuanceError"></span>
                                </div>

                                <!-- Present the QR code of the issuance -->
                                <div id="issuanceQRContainer" style="display: none;">
                                    <div class="d-flex justify-content-center">
                                        <div class="text-center">
                                            <h3>Scan QR Code with your mobile device</h3>
                                            <div id="issuanceQR" class="qr-container"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Display the PIN code for the issuance -->
                                <div id="issuancePinCodeContainer" class="text-center" style="display: none;">

                                </div>

                                <!-- Issuance Status -->
                                <div id="issuanceStatusContainer" class="status-section">
                                    <hr>
                                    <div class="d-flex align-items-center ">
                                        <div class="progress-circle" id="issuanceProgress">
                                            <div class="progress-circle-inner">0%</div>
                                        </div>
                                        <p id="issuanceStatusText" class="text-muted ms-3 mb-0">Waiting for response...
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Presentation UI -->
        <div id="presentationUI" class="hero-section" style="display: none;">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card shadow">
                            <div class="card-header bg-primary text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h2 class="mb-0">
                                        <i class="bi bi-card-checklist"></i> Present Your Credential
                                    </h2>
                                    <button type="button" class="btn btn-primary" onclick="showHomePage()">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="presentationPromptContainer" class="text-center">
                                    <p class="lead">Ready to share your verified ID credentials with us?</p>
                                    <button class="btn btn-primary btn-lg" onclick="StartPresentationFlow()">
                                        <i class="bi bi-share"></i> Start Presentation
                                    </button>
                                </div>

                                <!-- Claims container for presentation -->
                                <div id="presentationClaimsContainer" class="mt-4" style="display: none;">
                                    <h4>Your Claims</h4>
                                    <ul id="presentationClaims" class="list-unstyled">

                                    </ul>
                                </div>

                                <!-- Error message for presentation -->
                                <div id="presentationErrorContainer" class="alert alert-danger" style="display: none;"
                                    role="alert">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <span id="presentationError"></span>
                                </div>

                                <!-- Present the QR code of the presentation -->
                                <div id="presentationQRContainer" style="display: none;">
                                    <div class="d-flex justify-content-center">
                                        <div class="text-center">
                                            <h3>Scan QR Code with your mobile device</h3>
                                            <div id="presentationQR" class="qr-container"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Presentation Status -->
                                <div id="presentationStatusContainer" class="status-section">
                                    <hr>
                                    <div class="d-flex align-items-center ">
                                        <div class="progress-circle" id="presentationProgress">
                                            <div class="progress-circle-inner">0%</div>
                                        </div>
                                        <p id="presentationStatusText" class="text-muted ms-3 mb-0">Waiting for
                                            response...
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Hidden State Field -->
    <input type="hidden" id="currentState" value="">

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <script>
        // Global variables
        let statusCheckInterval;

        // Navigation functions
        function showHomePage() {
            $('#homePage').show();
            $('#issuanceUI').hide();
            $('#presentationUI').hide();
            clearStatusCheck();
        }

        function renderIssuanceUI() {
            $('#homePage').hide();
            $('#issuanceUI').show();
            $('#presentationUI').hide();
            $('#issuanceStatusContainer').hide();
            $('#issuanceErrorContainer').hide();
            $('#issuanceForm')[0].reset();
            $('#issuanceForm').show();
            $('#photoPreview').empty();
            clearStatusCheck();
        }

        function renderPresentationUI() {
            $('#homePage').hide();
            $('#issuanceUI').hide();
            $('#presentationUI').show();
            $('#presentationStatusContainer').hide();
            $('#presentationErrorContainer').hide();
            $('#presentationPromptContainer').show();
            $('#presentationQRContainer').hide();
            $('#presentationStatusText').text('');
            clearStatusCheck();
        }

        // Function to generate a GUID
        function generateGUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Function to generate a random PIN code between 1336 and 9984
        function generatePINCode() {
            const min = 1336;
            const max = 9984;
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Photo preview functionality
        $('#photoUpload').on('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    $('#photoPreview').html(`
                        <img id="photoPreviewImg" src="${e.target.result}" class="photo-preview img-thumbnail" alt="Photo preview">
                    `);
                };
                reader.readAsDataURL(file);
            }
        });

        // Issuance form submission
        $('#issuanceForm').on('submit', function (e) {
            e.preventDefault();
            StartIssuanceFlow();
        });

        // Start Issuance Flow
        function StartIssuanceFlow() {
            const displayName = $('#displayName').val();

            // Hide any previous errors
            $('#issuanceErrorContainer').hide();

            // Validate display name
            if (!displayName.trim()) {
                // Render the error message
                $('#issuanceError').text('Please enter a display name');
                $('#issuanceErrorContainer').show();
                return;
            }

            // Show the status section
            $('#issuanceStatusContainer').show();

            // Hide the issuance form and render the QR code
            $('#issuanceForm').hide();

            // Prepare the payload for issuance 
            const payload = {
                // Generate a new state for the issuance in GUID format
                state: generateGUID(),
                displayName: displayName,
                pin: generatePINCode(),

                // Check if the photoPreviewImg src is set, if not set to null
                photo: $('#photoPreviewImg').length ? $('#photoPreviewImg').attr('src') : ""

            };

            // Store the current state
            $('#currentState').val(payload.state);

            // Update the progress and status text
            updateProgress("issuance", 10, 'Processing...');

            // Start the issuance flow
            $.ajax({
                url: 'https://woodgroove.azure-api.net/vid/issuance',
                type: 'POST',
                data: JSON.stringify(payload),
                contentType: 'application/json',
                success: function (response) {
                    console.log('Issuance flow started:', response);

                    // Update the progress and status text
                    updateProgress("issuance", 35, 'Please scan the QR code with your mobile device');

                    // Render the PIN code
                    $('#issuancePinCodeContainer').html('<div class="pin-code">PIN code: ' + payload.pin + '</div>');
                    $('#issuancePinCodeContainer').show();

                    // Render the QR code
                    renderQRCode(response.url, 'issuanceQR');
                    $('#issuanceQRContainer').show();

                    // Start checking the status
                    startStatusCheck('issuance');
                },
                error: function (xhr, status, error) {
                    console.error('Issuance flow error:', xhr.responseText);
                    let errorMessage = 'Error starting issuance flow: ' + error;

                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.error && response.error.message) {
                            errorMessage = response.error.message;
                        }
                    } catch (e) {
                        // If parsing fails, use the default error message
                    }

                    // Render the error message
                    $('#issuanceError').text(errorMessage);
                    $('#issuanceErrorContainer').show();
                }
            });
        }


        // Start Presentation Flow
        function StartPresentationFlow() {

            // Set a state value for the presentation flow
            const payload = {
                state: generateGUID()
            };

            // Store the current state
            $('#currentState').val(payload.state);

            // Hide any previous errors
            $('#presentationErrorContainer').hide();

            // Hide the prompt container
            $('#presentationPromptContainer').hide();

            // Show the status section
            $('#presentationStatusContainer').show();

            // Update the progress and status text
            updateProgress("presentation", 10, 'Processing...');

            $.ajax({
                url: 'https://woodgroove.azure-api.net/vid/presentationfordemo',
                type: 'POST',
                data: JSON.stringify(payload),
                contentType: 'application/json',
                success: function (response) {

                    console.log('Presentation flow started:', response);

                    // Update the progress and status text
                    updateProgress("presentation", 35, 'Please scan the QR code with your mobile device');

                    // Render the QR code
                    $('#presentationQRContainer').show();
                    renderQRCode(response.url, 'presentationQR');

                    // Start checking the status
                    startStatusCheck('presentation');
                },
                error: function (xhr, status, error) {
                    console.error('Issuance flow error:', xhr.responseText);
                    let errorMessage = 'Error starting issuance flow: ' + error;

                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.error && response.error.message) {
                            errorMessage = response.error.message;
                        }
                    } catch (e) {
                        // If parsing fails, use the default error message
                    }

                    // Render the error message
                    $('#presentationError').text(errorMessage);
                    $('#presentationErrorContainer').show();
                }
            });
        }

        // Generate QR Code
        function renderQRCode(url, containerId) {
            // Clear previous QR code
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            console.log('Rendering QR code for URL:', url);
            console.log('Container ID:', container.id);

            // Create a new QR code
            var qrcode = new QRCode(container, {
                text: url,
                width: 170,
                height: 170,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
            });

            // Show the QR code container
            $(`#${containerId}Container`).show();
        }

        // Start status checking
        function startStatusCheck(type) {
            clearStatusCheck();

            statusCheckInterval = setInterval(function () {
                CheckStatus(type);
            }, 2000); // Check every 2 seconds
        }

        // Check Status
        function CheckStatus(type) {
            const state = $('#currentState').val();

            if (!state) {
                return;
            }

            $.ajax({
                url: 'https://woodgroove.azure-api.net/vid/status',
                type: 'POST',
                data: JSON.stringify({ state: state }),
                contentType: 'application/json',
                success: function (response) {

                    console.log('Status check response:', response);

                    // Update progress based on status
                    let progress = 0;
                    let message = '';
                    switch (response.status) {
                        case 'request_created':
                            progress = 35;
                            message = 'Please scan the QR code with your mobile device';

                            break;
                        case 'request_retrieved':
                            progress = 60;

                            if (type === 'issuance') {
                                message = 'Please enter the PIN code on your mobile device';

                                // Hide the issuance QR code container
                                $('#issuanceQRContainer').hide();
                            } else {
                                message = 'Please select the credentials to present on your mobile device';

                                // Hide the presentation QR code container
                                $('#presentationQRContainer').hide();
                            }

                            break;

                        case 'issuance_successful':
                            progress = 100;
                            message = 'You successfully obtained your credential, please check your mobile device';

                            // Hide the issuance PIN code container
                            $('#issuancePinCodeContainer').hide();

                            break;

                        case 'presentation_verified':
                            progress = 100;
                            message = 'Your credentials have been successfully verified.';

                            // Hide the presentation QR code container
                            $('#presentationQRContainer').hide();

                            // Show the claims
                            $('#presentationClaimsContainer').show();
                            $('#presentationClaims').empty();

                            // First take the claims string and parse it
                            const claims = JSON.parse(response.claims);

                            // This is the format of the claims, however we can't use the attributes name directly
                            //{displayName: 'Yoel Horvitz', photo: ''}

                            Object.entries(claims).forEach(([key, value]) => {

                                // Hide empty values
                                if (value) {
                                    $('#presentationClaims').append(`<li>${key}: ${value}</li>`);
                                }
                            });

                            break;
                    }


                    updateProgress(type, progress, message);

                    // Stop checking if completed
                    if (progress >= 100 || response.status === 'completed') {
                        clearStatusCheck();
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Status check error:', error);
                }
            });
        }

        // Update progress circle
        function updateProgress(type, progress, message) {
            const progressElement = $(`#${type}Progress`);
            const innerElement = progressElement.find('.progress-circle-inner');

            // Update text
            innerElement.text(Math.round(progress) + '%');

            // Update circle progress
            const degrees = (progress / 100) * 360;
            progressElement.css('background',
                `conic-gradient(#198754 ${degrees}deg, #e9ecef ${degrees}deg)`
            );

            // Update status text
            $(`#${type}StatusText`).text(message);
        }

        // Clear status checking
        function clearStatusCheck() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
        }

        // Initialize the application
        $(document).ready(function () {
            showHomePage();
        });
    </script>
</body>

</html>